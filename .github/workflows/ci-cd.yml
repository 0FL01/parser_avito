name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  DOCKER_IMAGE_NAME: avito-parser
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  VERSION: ${{ github.sha }}
  SHORT_VERSION: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.VERSION }}

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors'

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "
            mkdir -p ${{ secrets.APP_LOCATION }} && \
            cd ${{ secrets.APP_LOCATION }} && \
            echo 'version: \"3\"' > docker-compose.yml && \
            echo 'services:' >> docker-compose.yml && \
            echo '  avito-parser:' >> docker-compose.yml && \
            echo '    image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.VERSION }}' >> docker-compose.yml && \
            echo '    container_name: avito-parser' >> docker-compose.yml && \
            echo '    restart: unless-stopped' >> docker-compose.yml && \
            echo '    environment:' >> docker-compose.yml && \
            echo '      - URL_AVITO=$URL_AVITO' >> docker-compose.yml && \
            echo '      - CHAT_ID_TG=$CHAT_ID_TG' >> docker-compose.yml && \
            echo '      - TG_TOKEN=$TG_TOKEN' >> docker-compose.yml && \
            echo '      - NUM_ADS_AVITO=$NUM_ADS_AVITO' >> docker-compose.yml && \
            echo '      - FREQ_AVITO=$FREQ_AVITO' >> docker-compose.yml && \
            echo '      - KEYS_AVITO=$KEYS_AVITO' >> docker-compose.yml && \
            echo '      - MAX_PRICE_AVITO=$MAX_PRICE_AVITO' >> docker-compose.yml && \
            echo '      - MIN_PRICE_AVITO=$MIN_PRICE_AVITO' >> docker-compose.yml && \
            echo '      - NEED_MORE_INFO_AVITO=$NEED_MORE_INFO_AVITO' >> docker-compose.yml && \
            echo '      - DEBUG_MODE_AVITO=$DEBUG_MODE_AVITO' >> docker-compose.yml && \
            echo '      - FAST_SPEED_AVITO=$FAST_SPEED_AVITO' >> docker-compose.yml && \
            echo '      - MAX_VIEW_AVITO=$MAX_VIEW_AVITO' >> docker-compose.yml && \
            echo '      - KEYS_BLACK_AVITO=$KEYS_BLACK_AVITO' >> docker-compose.yml && \
            docker-compose down && \
            docker-compose up -d && \
            docker logs avito-parser
          "